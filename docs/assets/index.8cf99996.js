(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();const A="/libgif/assets/coug3.f85a27a3.gif",z="/libgif/assets/earth.b0acdc9a.gif",H="/libgif/assets/img5.64bf3f88.gif",N="/libgif/assets/gif1.5bf04440.gif",L="/libgif/assets/gif2.ba77dc11.gif",M="/libgif/assets/gif3.0e5e59d6.gif",_=[A,z,N,L,M,H];function U(h){return{all:h=h||new Map,on:function(t,e){var i=h.get(t);i?i.push(e):h.set(t,[e])},off:function(t,e){var i=h.get(t);i&&(e?i.splice(i.indexOf(e)>>>0,1):h.set(t,[]))},emit:function(t,e){var i=h.get(t);i&&i.slice().map(function(s){s(e)}),(i=h.get("*"))&&i.slice().map(function(s){s(t,e)})}}}class k{constructor(){this.emitter=U()}on(t,e){return this.emitter.on(t,e)}off(t,e){return this.emitter.off(t,e)}emit(t,e){return this.emitter.emit(t,e)}}class O extends k{constructor(){super(...arguments),this._loading=!1,this.load_raw=t=>{this._loading||(this._loading=!0,this.onLoad(t))}}get loading(){return this._loading}async load_url(t){return this._loading?void 0:(this._loading=!0,new Promise((e,i)=>{const s=new XMLHttpRequest;s.open("GET",t,!0),"overrideMimeType"in s?s.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in s?s.responseType="arraybuffer":s.setRequestHeader("Accept-Charset","x-user-defined"),s.onloadstart=()=>{this.emit("loadstart")},s.onload=r=>{s.status!=200&&(this.emit("error","xhr - response"),i("xhr - response")),"response"in s||Object.assign(this,{response:new window.VBArray(s.responseText).toArray().map(String.fromCharCode).join("")});let a="";typeof s.response=="string"?a=s.response:s.response.toString().indexOf("ArrayBuffer")>0&&(a=new Uint8Array(s.response)),e(a),this.onLoad(a)},s.onprogress=r=>{this.emit("progress",r)},s.onerror=()=>{this.emit("error","xhr"),i("xhr")},s.send()}))}onLoad(t){this._loading=!1,this.emit("load",t)}}const B=h=>h.reduce((t,e)=>t*2+Number(e),0),D=h=>{const t=[];for(let e=7;e>=0;e--)t.push(!!(h&1<<e));return t};class R{constructor(t){this.pos=0,this.data=t,this.len=this.data.length}readByte(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return this.data instanceof Uint8Array?this.data[this.pos++]:this.data.charCodeAt(this.pos++)&255}readBytes(t){const e=[];for(let i=0;i<t;i++)e.push(this.readByte());return e}read(t){let e="";for(let i=0;i<t;i++)e+=String.fromCharCode(this.readByte());return e}readUnsigned(){const[t,e]=this.readBytes(2);return(e<<8)+t}}const W=!0,q=()=>{let h=0;return()=>h++},E=h=>{const t=new Worker("/libgif/assets/funcWorker.b86fc165.js",{type:"module"}),e=q();return async(...i)=>{const s=e();return new Promise(r=>{const a=c=>{c.data.traceId===s&&(t.removeEventListener("message",a),r(c.data.data))};t.addEventListener("message",a),t.postMessage({args:i,traceId:s,funcName:h})})}},j={"":E(""),lzwDecode:E("lzwDecode")};class K extends k{constructor(){super(),this.canvas=document.createElement("canvas"),this.st=null,this.exts=[],this.opacity=255,this.frameGroup=[],this.parseColorTable=t=>{if(!this.st)return;const e=[];for(let i=0;i<t;i++)e.push(this.st.readBytes(3));return e},this.readSubBlocks=()=>{if(!this.st)return;let t,e;e="";do t=this.st.readByte(),e+=this.st.read(t);while(t!==0);return e},this.parseHeader=()=>{if(!this.st)return;let t=Date.now();const e=this.st.read(3),i=this.st.read(3);if(e!=="GIF")throw new Error("Not a GIF file.");const s=this.st.readUnsigned(),r=this.st.readUnsigned(),a=D(this.st.readByte()),c=!!a.shift(),n=B(a.splice(0,3)),d=!!a.shift(),l=B(a.splice(0,3)),u=this.st.readByte(),p=this.st.readByte(),g=c?this.parseColorTable(1<<l+1):void 0,m=g?g[u]:null,o={signature:e,version:i,logicalScreenWidth:s,logicalScreenHeight:r,globalColorTableFlag:c,ColorResolution:n,sortFlag:d,ColorTableSize:l,backgroundColorIndex:u,backgroundColor:m,pixelAspectRatio:p,globalColorTable:g};this.header=o,this.setCanvasSize(o.logicalScreenWidth,o.logicalScreenHeight),console.log(`parseHeader time: ${Date.now()-t}`),this.emit("header",o)},this.parseExt=t=>{if(!this.st)return;const e=d=>{if(!this.st)return;this.st.readByte();const l=D(this.st.readByte()),u=l.splice(0,3),p=B(l.splice(0,3)),g=!!l.shift(),m=!!l.shift(),o=this.st.readUnsigned()*10,f=this.st.readByte(),y=this.st.readByte(),x={...d,reserved:u,disposalMethod:p,userInput:g,transparencyGiven:m,delayTime:o,transparencyIndex:f,terminator:y};this.graphControll=x},i=d=>{if(!this.st)return;const l=this.readSubBlocks(),u={...d,comment:l};this.exts.push(u),this.emit("com",u)},s=d=>{if(!this.st)return;this.st.readByte();const l=this.st.readBytes(12),u=this.readSubBlocks(),p={...d,ptHeader:l,ptData:u};this.exts.push(p),this.emit("pte",p)},r=d=>{if(!this.st)return;const l=o=>{if(!this.st)return;this.st.readByte();const f=this.st.readByte(),y=this.st.readUnsigned(),x=this.st.readByte(),w={...o,unknown:f,iterations:y,terminator:x,identifier:"NETSCAPE"};this.app=w,this.emit("app",w)},u=o=>{const f=this.readSubBlocks(),y={...o,appData:f,identifier:o.identifier};this.app=y,this.emit("app",y)};this.st.readByte();const p=this.st.read(8),g=this.st.read(3),m={...d,identifier:p,authCode:g};switch(m.identifier){case"NETSCAPE":l(m);break;default:u(m);break}},a=d=>{const l=this.readSubBlocks(),u={...d,data:l};this.exts.push(u),this.emit("unknown",u)},c=this.st.readByte(),n={...t,label:c,extType:""};switch(n.label){case 249:n.extType="gce",e(n);break;case 254:n.extType="com",i(n);break;case 1:n.extType="pte",s(n);break;case 255:n.extType="app",r(n);break;default:n.extType="unknown",a(n);break}},this.parseImg=async t=>{if(!this.st)return;let e=Date.now();const i=(w,C)=>{const T=new Array(w.length),G=w.length/C,I=(v,b)=>{const $=w.slice(b*C,(b+1)*C);T.splice(v*C,C,...$)},P=[0,4,2,1],F=[8,8,4,2];let S=0;for(let v=0;v<4;v++)for(let b=P[v];b<G;b+=F[v])I(b,S),S++;return T},s=this.st.readUnsigned(),r=this.st.readUnsigned(),a=this.st.readUnsigned(),c=this.st.readUnsigned(),n=D(this.st.readByte()),d=n.shift(),l=n.shift(),u=n.shift(),p=n.splice(0,2),g=B(n.splice(0,3)),m=d?this.parseColorTable(1<<g+1):void 0,o=this.st.readByte(),f=this.readSubBlocks();let y=await j.lzwDecode(o,f);console.log(`lzwDecode time: ${Date.now()-e}`),l&&(y=i(y,a),console.log(`deinterlace time: ${Date.now()-e}`));const x={...t,leftPos:s,topPos:r,width:a,height:c,lctFlag:d,interlaced:l,sorted:u,reserved:p,lctSize:g,lct:m,lzwMinCodeSize:o,pixels:y};console.log(`parseImg time: ${Date.now()-e}`),this.parseFrame(x)},this.parseFrame=t=>{var e;let i=Date.now();const s=this.graphControll;s&&this.disposal(s.disposalMethod);const r=s&&s.transparencyGiven?s.transparencyIndex:null,a=s&&s.delayTime||100,c=t.lctFlag?t.lct:(e=this.header)==null?void 0:e.globalColorTable,n=this.getDraft(t);c&&t.pixels.forEach((l,u)=>{l!==r&&(n.data[u*4+0]=c[l][0],n.data[u*4+1]=c[l][1],n.data[u*4+2]=c[l][2],n.data[u*4+3]=this.opacity)});const d={data:n,delay:a,leftPos:t.leftPos,topPos:t.topPos,width:this.canvas.width,height:this.canvas.height};this.frameGroup.push(d),this.graphControll=void 0,console.log(`parseFrame time: ${Date.now()-i}`),this.emit("frame",d)},this.putDraft=(t,e=0,i=0)=>{const{width:s,height:r}=this.canvas;t?t instanceof ImageData?this.ctx.putImageData(t,e,i):(this.ctx.fillStyle=`rgb(${t.join(",")} )`,this.ctx.fillRect(0,0,s,r)):this.ctx.clearRect(0,0,s,r)},this.getDraft=t=>this.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),this.parseBlock=async()=>{if(!this.st)return;let t=Date.now();const e={sentinel:this.st.readByte(),type:""};switch(String.fromCharCode(e.sentinel)){case"!":e.type="ext",this.parseExt(e);break;case",":e.type="img",await this.parseImg(e);break;case";":e.type="complete",this.st=null,this.emit("complete",{...e,header:this.header,frameGroup:this.frameGroup,opacity:this.opacity});break;case"\0":e.type="complete",this.st=null,this.emit("complete",{...e,header:this.header,frameGroup:this.frameGroup,opacity:this.opacity});break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}console.log(`parseBlock time: ${Date.now()-t}, type:${e.type}`),e.type!=="complete"&&setTimeout(this.parseBlock,0)},this.parse=(t,e)=>{this.st||(this.st=t,e&&(this.opacity=e.opacity),this.parseHeader(),setTimeout(this.parseBlock,0))},this.ctx=this.canvas.getContext("2d")}get pos(){var t;return((t=this.st)==null?void 0:t.pos)||0}get len(){var t;return((t=this.st)==null?void 0:t.data.length)||0}get loading(){return!!this.st}setCanvasSize(t,e){this.canvas.width=t,this.canvas.height=e,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.setTransform(1,0,0,1,0,0)}disposal(t){const e=i=>{var s;const r=this.frameGroup[i];r?this.putDraft(r.data,r.leftPos,r.topPos):this.putDraft(((s=this.header)==null?void 0:s.backgroundColor)||null)};switch(t){case 3:e(this.frameGroup.length-1);break;case 2:e(-1);break}}}class V extends k{constructor(t){super(),this.i=-1,this.iterationCount=0,this.forward=!0,this.playing=!1,this.frameGroup=[],this.opacity=255,this.timestamp=0,this.t=0,this.finish=()=>{this.iterationCount++,this.emit("finish"),this.quote.overrideLoopMode||this.iterationCount<1?this.goOn():this.pause()},this.goOn=()=>{if(!this.playing)return;this.putFrameBy(1);const e=this.frameGroup[this.i].delay,i=this.getNextFrameNo()===0;clearTimeout(this.t),this.t=i?window.setTimeout(this.finish,e):window.setTimeout(this.goOn,e)},this.putFrameBy=e=>{this.i=this.i+e,this.putFrame()},this.play=()=>{this.playing||(this.playing=!0,this.goOn())},this.pause=()=>{this.playing=!1},this.move_to=e=>{this.i=e,this.putFrame()},this.resetState=()=>{clearTimeout(this.t),this.i=-1,this.iterationCount=0,this.forward=!0,this.playing=!1,this.frameGroup=[],this.opacity=255,this.timestamp=0},this.onHeader=e=>{this.resetState(),this.quote.viewer.adapt({width:e.logicalScreenWidth,height:e.logicalScreenHeight})},this.onFrame=e=>{this.frameGroup.push(e),this.play()},this.onError=()=>{this.resetState()},this.quote=t}getNextFrameNo(){const t=this.forward?1:-1;return(this.i+t+this.frameGroup.length)%this.frameGroup.length}putFrame(t){typeof t=="number"&&(this.i=t),(this.i<0||this.i>=this.frameGroup.length)&&(this.i=0);const e=this.frameGroup[this.i];this.quote.viewer.putDraft(e.data,e.leftPos,e.topPos),this.quote.viewer.drawDraft()}current_frame(){return this.i}}class X{constructor(){this.canvas=document.createElement("canvas"),this.draftCanvas=document.createElement("canvas"),this.opacity=255,this.zoomW=1,this.zoomH=1,this.drawError=t=>{console.error(t),this.ctx.fillStyle="black";const e=this.canvas.width,i=this.canvas.height;this.ctx.fillRect(0,0,e,i),this.ctx.strokeStyle="red",this.ctx.lineWidth=3,this.ctx.moveTo(0,0),this.ctx.lineTo(e,i),this.ctx.moveTo(0,i),this.ctx.lineTo(e,0),this.ctx.stroke()},this.ctx=this.canvas.getContext("2d"),this.draftCtx=this.draftCanvas.getContext("2d")}get showProgressBar(){var t;return((t=this.$el)==null?void 0:t.getAttribute("progress_bar"))!=="none"}get isMounted(){var t;return!!((t=this.canvas.parentNode)!=null&&t.parentNode)}mount(t){if(this.isMounted)return;const e=t.parentNode;if(!e)return;this.$el=t;const i=document.createElement("div");i.style.display="inline-block";const s=Number(t.getAttribute("width"))||0,r=Number(t.getAttribute("height"))||0;this.canvas.id="\u91CD\u6784",this.canvas.style.display="block",this.canvas.width=s,this.canvas.height=r,i.appendChild(this.canvas),e.insertBefore(i,t),e.removeChild(t)}adapt(t){if(!this.$el)return;const e=this.$el.getAttribute("width"),i=e?parseInt(e):t.width,s=i/t.width,r=this.$el.getAttribute("height"),a=r?parseInt(r):t.height,c=a/t.height;this.canvas.width=i,this.canvas.height=a,this.ctx.scale(s,c),this.zoomW=s,this.zoomH=c,this.draftCanvas.width=t.width,this.draftCanvas.height=t.height,this.draftCanvas.style.width=t.width+"px",this.draftCanvas.style.height=t.height+"px",this.draftCtx.setTransform(1,0,0,1,0,0)}drawProgress(t){if(t>1||t<0||!this.showProgressBar)return;let e=1;const i=(this.canvas.height-e)/this.zoomH,s=t*this.canvas.width/this.zoomW;e=e/this.zoomH;const r=this.canvas.width/this.zoomW;this.ctx.fillStyle="rgba(255,255,255,0.4)",this.ctx.fillRect(s,i,r-s,e),this.ctx.fillStyle="rgba(0,123,255,0.4)",this.ctx.fillRect(0,i,s,e)}getDraft(t){return this.draftCtx.getImageData(t.leftPos,t.topPos,t.width,t.height)}putDraft(t,e=0,i=0){const{width:s,height:r}=this.draftCanvas;t?t instanceof ImageData?this.draftCtx.putImageData(t,e,i):(this.draftCtx.fillStyle=`rgb(${t.join(",")} )`,this.draftCtx.fillRect(0,0,s,r)):this.draftCtx.clearRect(0,0,s,r)}drawDraft(){this.ctx.drawImage(this.draftCanvas,0,0)}}const J=h=>{let t=0;const e=new k,i=Object.assign({},h),s=i.gif,r=new X;r.mount(s);const a=new V({overrideLoopMode:i.loop_mode!==!1,viewer:r});a.on("finish",()=>e.emit("finish",s));const c=new K,n=o=>(...f)=>{o(...f),r.drawProgress(c.pos/c.len)};c.on("header",n(o=>{a.onHeader(o)})),c.on("frame",n(o=>{a.onFrame(o)})),c.on("complete",n(o=>{console.log("decode time:",Date.now()-t),e.emit("load",s)}));const d=new O;d.on("load",o=>{}),d.on("progress",o=>{o.lengthComputable&&r.drawProgress(o.loaded/o.total)}),d.on("error",o=>{a.onError(),r.drawError(o)});const l=()=>d.loading||c.loading,u=o=>{if(!l())try{const f=new R(o);return W&&(t=Date.now()),c.parse(f)}catch{r.drawError(`load raw error with\u3010${o.slice(0,8)}\u3011`)}},p=async o=>{if(!l())try{const f=await d.load_url(o);return g(f)}catch{r.drawError(`load url error with\u3010${o}\u3011`)}},g=o=>u(o),m=()=>p(s.getAttribute("rel:animated_src")||s.getAttribute("src")||"");return{player:a,play:a.play,pause:a.pause,move_relative:a.putFrameBy,move_to:a.move_to,get_playing:()=>a.playing,get_current_frame:()=>a.current_frame(),get_canvas:()=>r.canvas,get_loading:l,get_auto_play:()=>i,load_url:p,load:m,load_raw:g,get frames(){return a.frameGroup},get_length:()=>a.frameGroup.length,on:e.on,off:e.off}},Q=()=>{const h=document.getElementById("useDemo"),t=_[1],e=Math.random().toString().slice(2);h.innerHTML=` 
    <div style="margin: 8px 0">
     ${_.map((r,a)=>`<button url="${r}">GIF${a}</button>`).join(" ")}
    </div>
    <div
    id="${e}"
    src="${t}"
    rel:animated_src="${t}"
    width="300"
    height="300"
    rel:auto_play="1"
    rel:rubbable="1"
    /> 
  `;const i=document.getElementById(e),s=J({gif:i});return s.load(),h.addEventListener("click",r=>{if(r.target instanceof HTMLElement){const a=r.target.getAttribute("url");a&&s.load_url(a)}}),s};Q();

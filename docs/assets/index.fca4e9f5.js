(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();const A="/libgif/assets/coug3.f85a27a3.gif",F="/libgif/assets/earth.b0acdc9a.gif",H="/libgif/assets/img5.64bf3f88.gif",M="/libgif/assets/gif1.5bf04440.gif",N="/libgif/assets/gif2.ba77dc11.gif",z="/libgif/assets/gif3.0e5e59d6.gif",_=[A,F,M,N,z,H];function L(l){return{all:l=l||new Map,on:function(t,e){var i=l.get(t);i?i.push(e):l.set(t,[e])},off:function(t,e){var i=l.get(t);i&&(e?i.splice(i.indexOf(e)>>>0,1):l.set(t,[]))},emit:function(t,e){var i=l.get(t);i&&i.slice().map(function(s){s(e)}),(i=l.get("*"))&&i.slice().map(function(s){s(t,e)})}}}class k{constructor(){this.emitter=L()}on(t,e){return this.emitter.on(t,e)}off(t,e){return this.emitter.off(t,e)}emit(t,e){return this.emitter.emit(t,e)}}class U extends k{constructor(){super(...arguments),this._loading=!1,this.load_raw=t=>{this._loading||(this._loading=!0,this.onLoad(t))}}get loading(){return this._loading}async load_url(t){return this._loading?void 0:(this._loading=!0,new Promise((e,i)=>{const s=new XMLHttpRequest;s.open("GET",t,!0),"overrideMimeType"in s?s.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in s?s.responseType="arraybuffer":s.setRequestHeader("Accept-Charset","x-user-defined"),s.onloadstart=()=>{this.emit("loadstart")},s.onload=r=>{s.status!=200&&(this.emit("error","xhr - response"),i("xhr - response")),"response"in s||Object.assign(this,{response:new window.VBArray(s.responseText).toArray().map(String.fromCharCode).join("")});let a="";typeof s.response=="string"?a=s.response:s.response.toString().indexOf("ArrayBuffer")>0&&(a=new Uint8Array(s.response)),e(a),this.onLoad(a)},s.onprogress=r=>{this.emit("progress",r)},s.onerror=()=>{this.emit("error","xhr"),i("xhr")},s.send()}))}onLoad(t){this._loading=!1,this.emit("load",t)}}const O=(l,t)=>{let e=0;const i=p=>{let g=0;for(let f=0;f<p;f++)(t instanceof Uint8Array?t[e>>3]:t.charCodeAt(e>>3))&1<<(e&7)&&(g|=1<<f),e++;return g},s=[],r=1<<l,a=r+1;let c=l+1,o=[];const u=()=>{c=l+1,o=[];for(let p=0;p<r;p++)o[p]=[p];o[r]=[],o[a]=null};let n=0,d;for(;;){if(d=n,n=i(c),n===r){u();continue}else{if(n===a)break;if(n>o.length)throw new Error("Invalid LZW code.");n===o.length?o.push(o[d].concat(o[d][0])):d!==r&&o.push(o[d].concat(o[n][0]))}if(s.push(...o[n]),o.length===1<<c&&c<12&&c++,e>=t.length*8)break}return s},B=l=>l.reduce((t,e)=>t*2+Number(e),0),S=l=>{const t=[];for(let e=7;e>=0;e--)t.push(!!(l&1<<e));return t};class R{constructor(t){this.pos=0,this.data=t,this.len=this.data.length}readByte(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return this.data instanceof Uint8Array?this.data[this.pos++]:this.data.charCodeAt(this.pos++)&255}readBytes(t){const e=[];for(let i=0;i<t;i++)e.push(this.readByte());return e}read(t){let e="";for(let i=0;i<t;i++)e+=String.fromCharCode(this.readByte());return e}readUnsigned(){const[t,e]=this.readBytes(2);return(e<<8)+t}}const W=()=>{let l=0;return()=>`${l++}`},q=l=>{const t=W(),e=`
    const func = ${l.toString()};
    onmessage= async (event) => {
      const { traceId, args } = event.data
      const data = await func.apply(void 0, args)
      self.postMessage({ traceId, data })
    };
  `,i=new Worker(`data:application/javascript,${encodeURIComponent(e)}`);return async(...s)=>{const r=t();return new Promise(a=>{i.onmessage=c=>{c.data.traceId===r&&a(c.data.data)},i.postMessage({args:s,traceId:r})})}},j=!0,K=q(O);class V extends k{constructor(){super(),this.canvas=document.createElement("canvas"),this.st=null,this.exts=[],this.opacity=255,this.frameGroup=[],this.parseColorTable=t=>{if(!this.st)return;const e=[];for(let i=0;i<t;i++)e.push(this.st.readBytes(3));return e},this.readSubBlocks=()=>{if(!this.st)return;let t,e;e="";do t=this.st.readByte(),e+=this.st.read(t);while(t!==0);return e},this.parseHeader=()=>{if(!this.st)return;let t=Date.now();const e=this.st.read(3),i=this.st.read(3);if(e!=="GIF")throw new Error("Not a GIF file.");const s=this.st.readUnsigned(),r=this.st.readUnsigned(),a=S(this.st.readByte()),c=!!a.shift(),o=B(a.splice(0,3)),u=!!a.shift(),n=B(a.splice(0,3)),d=this.st.readByte(),p=this.st.readByte(),g=c?this.parseColorTable(1<<n+1):void 0,f=g?g[d]:null,h={signature:e,version:i,logicalScreenWidth:s,logicalScreenHeight:r,globalColorTableFlag:c,ColorResolution:o,sortFlag:u,ColorTableSize:n,backgroundColorIndex:d,backgroundColor:f,pixelAspectRatio:p,globalColorTable:g};this.header=h,this.setCanvasSize(h.logicalScreenWidth,h.logicalScreenHeight),console.log(`parseHeader time: ${Date.now()-t}`),this.emit("header",h)},this.parseExt=t=>{if(!this.st)return;const e=u=>{if(!this.st)return;this.st.readByte();const n=S(this.st.readByte()),d=n.splice(0,3),p=B(n.splice(0,3)),g=!!n.shift(),f=!!n.shift(),h=this.st.readUnsigned()*10,m=this.st.readByte(),y=this.st.readByte(),x={...u,reserved:d,disposalMethod:p,userInput:g,transparencyGiven:f,delayTime:h,transparencyIndex:m,terminator:y};this.graphControll=x},i=u=>{if(!this.st)return;const n=this.readSubBlocks(),d={...u,comment:n};this.exts.push(d),this.emit("com",d)},s=u=>{if(!this.st)return;this.st.readByte();const n=this.st.readBytes(12),d=this.readSubBlocks(),p={...u,ptHeader:n,ptData:d};this.exts.push(p),this.emit("pte",p)},r=u=>{if(!this.st)return;const n=h=>{if(!this.st)return;this.st.readByte();const m=this.st.readByte(),y=this.st.readUnsigned(),x=this.st.readByte(),w={...h,unknown:m,iterations:y,terminator:x,identifier:"NETSCAPE"};this.app=w,this.emit("app",w)},d=h=>{const m=this.readSubBlocks(),y={...h,appData:m,identifier:h.identifier};this.app=y,this.emit("app",y)};this.st.readByte();const p=this.st.read(8),g=this.st.read(3),f={...u,identifier:p,authCode:g};switch(f.identifier){case"NETSCAPE":n(f);break;default:d(f);break}},a=u=>{const n=this.readSubBlocks(),d={...u,data:n};this.exts.push(d),this.emit("unknown",d)},c=this.st.readByte(),o={...t,label:c,extType:""};switch(o.label){case 249:o.extType="gce",e(o);break;case 254:o.extType="com",i(o);break;case 1:o.extType="pte",s(o);break;case 255:o.extType="app",r(o);break;default:o.extType="unknown",a(o);break}},this.parseImg=async t=>{if(!this.st)return;let e=Date.now();const i=(w,C)=>{const T=new Array(w.length),I=w.length/C,E=(v,b)=>{const $=w.slice(b*C,(b+1)*C);T.splice(v*C,C,...$)},G=[0,4,2,1],P=[8,8,4,2];let D=0;for(let v=0;v<4;v++)for(let b=G[v];b<I;b+=P[v])E(b,D),D++;return T},s=this.st.readUnsigned(),r=this.st.readUnsigned(),a=this.st.readUnsigned(),c=this.st.readUnsigned(),o=S(this.st.readByte()),u=o.shift(),n=o.shift(),d=o.shift(),p=o.splice(0,2),g=B(o.splice(0,3)),f=u?this.parseColorTable(1<<g+1):void 0,h=this.st.readByte(),m=this.readSubBlocks();let y=await K(h,m);console.log(`lzwDecode time: ${Date.now()-e}`),n&&(y=i(y,a),console.log(`deinterlace time: ${Date.now()-e}`));const x={...t,leftPos:s,topPos:r,width:a,height:c,lctFlag:u,interlaced:n,sorted:d,reserved:p,lctSize:g,lct:f,lzwMinCodeSize:h,pixels:y};console.log(`parseImg time: ${Date.now()-e}`),this.parseFrame(x)},this.parseFrame=t=>{var e;let i=Date.now();const s=this.graphControll;s&&this.disposal(s.disposalMethod);const r=s&&s.transparencyGiven?s.transparencyIndex:null,a=s&&s.delayTime||100,c=t.lctFlag?t.lct:(e=this.header)==null?void 0:e.globalColorTable,o=this.getDraft(t);c&&t.pixels.forEach((n,d)=>{n!==r&&(o.data[d*4+0]=c[n][0],o.data[d*4+1]=c[n][1],o.data[d*4+2]=c[n][2],o.data[d*4+3]=this.opacity)});const u={data:o,delay:a,leftPos:t.leftPos,topPos:t.topPos,width:this.canvas.width,height:this.canvas.height};this.frameGroup.push(u),this.graphControll=void 0,console.log(`parseFrame time: ${Date.now()-i}`),this.emit("frame",u)},this.putDraft=(t,e=0,i=0)=>{const{width:s,height:r}=this.canvas;t?t instanceof ImageData?this.ctx.putImageData(t,e,i):(this.ctx.fillStyle=`rgb(${t.join(",")} )`,this.ctx.fillRect(0,0,s,r)):this.ctx.clearRect(0,0,s,r)},this.getDraft=t=>this.ctx.getImageData(t.leftPos,t.topPos,t.width,t.height),this.parseBlock=async()=>{if(!this.st)return;let t=Date.now();const e={sentinel:this.st.readByte(),type:""};switch(String.fromCharCode(e.sentinel)){case"!":e.type="ext",this.parseExt(e);break;case",":e.type="img",await this.parseImg(e);break;case";":e.type="complete",this.st=null,this.emit("complete",{...e,header:this.header,frameGroup:this.frameGroup,opacity:this.opacity});break;case"\0":e.type="complete",this.st=null,this.emit("complete",{...e,header:this.header,frameGroup:this.frameGroup,opacity:this.opacity});break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}console.log(`parseBlock time: ${Date.now()-t}, type:${e.type}`),e.type!=="complete"&&setTimeout(this.parseBlock,0)},this.parse=(t,e)=>{this.st||(this.st=t,e&&(this.opacity=e.opacity),this.parseHeader(),setTimeout(this.parseBlock,0))},this.ctx=this.canvas.getContext("2d")}get pos(){var t;return((t=this.st)==null?void 0:t.pos)||0}get len(){var t;return((t=this.st)==null?void 0:t.data.length)||0}get loading(){return!!this.st}setCanvasSize(t,e){this.canvas.width=t,this.canvas.height=e,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.setTransform(1,0,0,1,0,0)}disposal(t){const e=i=>{var s;const r=this.frameGroup[i];r?this.putDraft(r.data,r.leftPos,r.topPos):this.putDraft(((s=this.header)==null?void 0:s.backgroundColor)||null)};switch(t){case 3:e(this.frameGroup.length-1);break;case 2:e(-1);break}}}class X extends k{constructor(t){super(),this.i=-1,this.iterationCount=0,this.forward=!0,this.playing=!1,this.frameGroup=[],this.opacity=255,this.timestamp=0,this.t=0,this.finish=()=>{this.iterationCount++,this.emit("finish"),this.quote.overrideLoopMode||this.iterationCount<1?this.goOn():this.pause()},this.goOn=()=>{if(!this.playing)return;this.putFrameBy(1);const e=this.frameGroup[this.i].delay,i=this.getNextFrameNo()===0;clearTimeout(this.t),this.t=i?window.setTimeout(this.finish,e):window.setTimeout(this.goOn,e)},this.putFrameBy=e=>{this.i=this.i+e,this.putFrame()},this.play=()=>{this.playing||(this.playing=!0,this.goOn())},this.pause=()=>{this.playing=!1},this.move_to=e=>{this.i=e,this.putFrame()},this.resetState=()=>{clearTimeout(this.t),this.i=-1,this.iterationCount=0,this.forward=!0,this.playing=!1,this.frameGroup=[],this.opacity=255,this.timestamp=0},this.onHeader=e=>{this.resetState(),this.quote.viewer.adapt({width:e.logicalScreenWidth,height:e.logicalScreenHeight})},this.onFrame=e=>{this.frameGroup.push(e),this.play()},this.onError=()=>{this.resetState()},this.quote=t}getNextFrameNo(){const t=this.forward?1:-1;return(this.i+t+this.frameGroup.length)%this.frameGroup.length}putFrame(t){typeof t=="number"&&(this.i=t),(this.i<0||this.i>=this.frameGroup.length)&&(this.i=0);const e=this.frameGroup[this.i];this.quote.viewer.putDraft(e.data,e.leftPos,e.topPos),this.quote.viewer.drawDraft()}current_frame(){return this.i}}class Z{constructor(){this.canvas=document.createElement("canvas"),this.draftCanvas=document.createElement("canvas"),this.opacity=255,this.zoomW=1,this.zoomH=1,this.drawError=t=>{console.error(t),this.ctx.fillStyle="black";const e=this.canvas.width,i=this.canvas.height;this.ctx.fillRect(0,0,e,i),this.ctx.strokeStyle="red",this.ctx.lineWidth=3,this.ctx.moveTo(0,0),this.ctx.lineTo(e,i),this.ctx.moveTo(0,i),this.ctx.lineTo(e,0),this.ctx.stroke()},this.ctx=this.canvas.getContext("2d"),this.draftCtx=this.draftCanvas.getContext("2d")}get showProgressBar(){var t;return((t=this.$el)==null?void 0:t.getAttribute("progress_bar"))!=="none"}get isMounted(){var t;return!!((t=this.canvas.parentNode)!=null&&t.parentNode)}mount(t){if(this.isMounted)return;const e=t.parentNode;if(!e)return;this.$el=t;const i=document.createElement("div");i.style.display="inline-block";const s=Number(t.getAttribute("width"))||0,r=Number(t.getAttribute("height"))||0;this.canvas.id="\u91CD\u6784",this.canvas.style.display="block",this.canvas.width=s,this.canvas.height=r,i.appendChild(this.canvas),e.insertBefore(i,t),e.removeChild(t)}adapt(t){if(!this.$el)return;const e=this.$el.getAttribute("width"),i=e?parseInt(e):t.width,s=i/t.width,r=this.$el.getAttribute("height"),a=r?parseInt(r):t.height,c=a/t.height;this.canvas.width=i,this.canvas.height=a,this.ctx.scale(s,c),this.zoomW=s,this.zoomH=c,this.draftCanvas.width=t.width,this.draftCanvas.height=t.height,this.draftCanvas.style.width=t.width+"px",this.draftCanvas.style.height=t.height+"px",this.draftCtx.setTransform(1,0,0,1,0,0)}drawProgress(t){if(t>1||t<0||!this.showProgressBar)return;let e=1;const i=(this.canvas.height-e)/this.zoomH,s=t*this.canvas.width/this.zoomW;e=e/this.zoomH;const r=this.canvas.width/this.zoomW;this.ctx.fillStyle="rgba(255,255,255,0.4)",this.ctx.fillRect(s,i,r-s,e),this.ctx.fillStyle="rgba(0,123,255,0.4)",this.ctx.fillRect(0,i,s,e)}getDraft(t){return this.draftCtx.getImageData(t.leftPos,t.topPos,t.width,t.height)}putDraft(t,e=0,i=0){const{width:s,height:r}=this.draftCanvas;t?t instanceof ImageData?this.draftCtx.putImageData(t,e,i):(this.draftCtx.fillStyle=`rgb(${t.join(",")} )`,this.draftCtx.fillRect(0,0,s,r)):this.draftCtx.clearRect(0,0,s,r)}drawDraft(){this.ctx.drawImage(this.draftCanvas,0,0)}}const J=l=>{let t=0;const e=new k,i=Object.assign({},l),s=i.gif,r=new Z;r.mount(s);const a=new X({overrideLoopMode:i.loop_mode!==!1,viewer:r});a.on("finish",()=>e.emit("finish",s));const c=new V,o=h=>(...m)=>{h(...m),r.drawProgress(c.pos/c.len)};c.on("header",o(h=>{a.onHeader(h)})),c.on("frame",o(h=>{a.onFrame(h)})),c.on("complete",o(h=>{console.log("decode time:",Date.now()-t),e.emit("load",s)}));const u=new U;u.on("load",h=>{}),u.on("progress",h=>{h.lengthComputable&&r.drawProgress(h.loaded/h.total)}),u.on("error",h=>{a.onError(),r.drawError(h)});const n=()=>u.loading||c.loading,d=h=>{if(!n())try{const m=new R(h);return j&&(t=Date.now()),c.parse(m)}catch{r.drawError(`load raw error with\u3010${h.slice(0,8)}\u3011`)}},p=async h=>{if(!n())try{const m=await u.load_url(h);return g(m)}catch{r.drawError(`load url error with\u3010${h}\u3011`)}},g=h=>d(h),f=()=>p(s.getAttribute("rel:animated_src")||s.getAttribute("src")||"");return{player:a,play:a.play,pause:a.pause,move_relative:a.putFrameBy,move_to:a.move_to,get_playing:()=>a.playing,get_current_frame:()=>a.current_frame(),get_canvas:()=>r.canvas,get_loading:n,get_auto_play:()=>i,load_url:p,load:f,load_raw:g,get frames(){return a.frameGroup},get_length:()=>a.frameGroup.length,on:e.on,off:e.off}},Q=()=>{const l=document.getElementById("useDemo"),t=_[1],e=Math.random().toString().slice(2);l.innerHTML=` 
    <div style="margin: 8px 0">
     ${_.map((r,a)=>`<button url="${r}">GIF${a}</button>`).join(" ")}
    </div>
    <div
    id="${e}"
    src="${t}"
    rel:animated_src="${t}"
    width="300"
    height="300"
    rel:auto_play="1"
    rel:rubbable="1"
    /> 
  `;const i=document.getElementById(e),s=J({gif:i});return s.load(),l.addEventListener("click",r=>{if(r.target instanceof HTMLElement){const a=r.target.getAttribute("url");a&&s.load_url(a)}}),s};Q();
